<div
  class="subscriptions-portal"
  data-app="subscriptions-portal"
  data-endpoint="{{ block.settings.endpoint }}"
  data-debug="{{ block.settings.debug }}"
>
  {% if block.settings.heading != blank %}
    <h2>{{ block.settings.heading }}</h2>
  {% endif %}

  {% unless customer %}
    {% if block.settings.redirect_to_login %}
      {%- assign return_to = request.path | append: request.query_string -%}
      <meta http-equiv="refresh" content="0; url={{ routes.account_login_url }}?return_url={{ return_to | url_encode }}">
      <script>
        (function(){
          var returnTo = {{ return_to | json }};
          window.location.href = {{ routes.account_login_url | json }} + "?return_url=" + encodeURIComponent(returnTo);
        })();
      </script>
      <p>Redirecting to login…</p>
    {% else %}
      <div style="padding:14px;border:1px solid #e5e7eb;border-radius:12px;">
        <p><strong>Please log in</strong> to manage your subscriptions.</p>
        <p style="margin-top:10px;">
          <a href="{{ routes.account_login_url }}?return_url={{ request.path | url_encode }}">
            Log in
          </a>
        </p>
      </div>
    {% endif %}

  {% else %}
    <div id="subscriptions-portal-root">
      {% if request.design_mode %}
        <div style="padding: 14px; border: 1px dashed #d1d5db; border-radius: 10px;">
          <strong>Subscriptions Portal</strong>
          <p style="margin: 6px 0 0; color: #6b7280;">
            Logged-in preview may differ in the theme editor. View on the live storefront to test signed requests.
          </p>
        </div>
      {% else %}
        <p>Loading your subscriptions…</p>
      {% endif %}
    </div>

    {{ 'subscription-portal.js' | asset_url | script_tag }}
  {% endunless %}
</div>

{% schema %}
{
  "name": "Subscriptions Portal",
  "target": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Manage your subscriptions" },
    {
      "type": "text",
      "id": "endpoint",
      "label": "App Proxy base endpoint",
      "default": "/apps/portal",
      "info": "Base path for the portal routes (example: /apps/portal)."
    },
    { "type": "checkbox", "id": "redirect_to_login", "label": "Auto-redirect to login when logged out", "default": true },
    { "type": "checkbox", "id": "debug", "label": "Debug mode", "default": false }
  ]
}
{% endschema %}