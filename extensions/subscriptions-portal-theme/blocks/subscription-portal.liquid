<div
  class="subscriptions-portal"
  data-app="subscriptions-portal"
  data-endpoint="{{ block.settings.endpoint }}"
  data-debug="{{ block.settings.debug }}"
  data-portal-page="{{ block.settings.portal_page_path }}"
  {% if customer %}
    data-first-name="{{ customer.first_name | escape }}"
    data-email="{{ customer.email | escape }}"
  {% endif %}
>
{{ 'portal.css' | asset_url | stylesheet_tag }}
{% if block.settings.heading != blank %}
  <h2 class="sp-page-title">{{ block.settings.heading }}</h2>
  <div class="sp-page-subhead">
    <span class="sp-pill sp-pill--secure">ðŸ”’ Secure portal</span>
  </div>
{% endif %}

  {% unless customer %}
    {%- assign return_to = request.path -%}
    {%- if request.query_string != blank -%}
      {%- assign return_to = return_to | append: '?' | append: request.query_string -%}
    {%- endif -%}

    {% if block.settings.redirect_to_login %}
      <meta
        http-equiv="refresh"
        content="0; url={{ routes.account_login_url }}?return_url={{ return_to | url_encode }}"
      >
      <script>
        (function () {
          var returnTo = {{ return_to | json }};
          window.location.href =
            {{ routes.account_login_url | json }} +
            "?return_url=" +
            encodeURIComponent(returnTo);
        })();
      </script>
      <p>Redirecting to loginâ€¦</p>
    {% else %}
      <div style="padding:14px;border:1px solid #e5e7eb;border-radius:12px;">
        <p><strong>Please log in</strong> to manage your subscriptions.</p>
        <p style="margin-top:10px;">
          <a href="{{ routes.account_login_url }}?return_url={{ return_to | url_encode }}">
            Log in
          </a>
        </p>
      </div>
    {% endif %}

  {% else %}
    <div id="subscriptions-portal-root">
      {% if request.design_mode %}
        <div style="padding: 14px; border: 1px dashed #d1d5db; border-radius: 10px;">
          <strong>Subscriptions Portal</strong>
          <p style="margin: 6px 0 0; color: #6b7280;">
            Logged-in preview may differ in the theme editor. View on the live storefront to test signed requests.
          </p>
        </div>
      {% else %}
        <p style="text-align: center;">Loadingâ€¦</p>
      {% endif %}
    </div>

    <script src="{{ 'subscription-portal.js' | asset_url }}" defer></script>
  {% endunless %}
</div>


{% schema %}
{
  "name": "Subscriptions Portal",
  "target": "section",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Manage your subscriptions" },
    {
      "type": "text",
      "id": "portal_page_path",
      "label": "Portal page path",
      "default": "/pages/portal",
      "info": "Where this portal lives (example: /pages/portal). Used to map /pages/portal/* -> /apps/portal/*."
    },
    {
      "type": "text",
      "id": "endpoint",
      "label": "App Proxy base endpoint",
      "default": "/apps/portal",
      "info": "Base path for the portal routes (example: /apps/portal)."
    },
    { "type": "checkbox", "id": "redirect_to_login", "label": "Auto-redirect to login when logged out", "default": true },
    { "type": "checkbox", "id": "debug", "label": "Debug mode", "default": false }
  ]
}
{% endschema %}