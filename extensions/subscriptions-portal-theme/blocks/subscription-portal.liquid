<div
  class="subscriptions-portal"
  data-app="subscriptions-portal"
  data-endpoint="{{ block.settings.endpoint }}"
  data-debug="{{ block.settings.debug }}"
  data-portal-page="{{ block.settings.portal_page_path }}"
  data-lock-window-days="{{ block.settings.lock_window_days }}"
  data-selling-plan-week-4="{{ block.settings.selling_plan_week_4 }}"
  data-selling-plan-week-8="{{ block.settings.selling_plan_week_8 }}"
  data-selling-plan-week-2="{{ block.settings.selling_plan_week_2 }}"
  data-shipping-protection-variant-ids='[
    {%- if block.settings.shipping_protection_product -%}
      {%- for v in block.settings.shipping_protection_product.variants -%}
        {%- if v.available -%}
          {{- v.id | json -}}{% unless forloop.last %},{% endunless %}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  ]'

  data-products-available-to-add='[
    {%- for p in block.settings.products_available_to_add -%}
      {
        "productId": {{ p.id | json }},
        "title": {{ p.title | json }},
        "variants": [
          {%- assign has_variants = false -%}
          {%- for v in p.variants -%}
            {%- if v.available -%}
              {%- if has_variants %},{% endif -%}
              {
                "id": {{ v.id | json }},
                "title": {{ v.title | json }}
              }
              {%- assign has_variants = true -%}
            {%- endif -%}
          {%- endfor -%}
        ]
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ]'

  data-addons='[
    {%- for p in block.settings.addons -%}
      {
        "productId": {{ p.id | json }},
        "title": {{ p.title | json }},
        "variants": [
          {%- assign has_variants = false -%}
          {%- for v in p.variants -%}
            {%- if v.available -%}
              {%- if has_variants %},{% endif -%}
              {
                "id": {{ v.id | json }},
                "title": {{ v.title | json }}
              }
              {%- assign has_variants = true -%}
            {%- endif -%}
          {%- endfor -%}
        ]
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ]'
  {% if customer %}
    data-first-name="{{ customer.first_name | escape }}"
    data-last-name="{{ customer.last_name | escape }}"
    data-email="{{ customer.email | escape }}"
  {% endif %}
>
  {{ 'portal.css' | asset_url | stylesheet_tag }}

  {% if block.settings.heading != blank %}
    <div class="app-title-wrapper">
      <h2 class="sp-page-title">{{ block.settings.heading }}</h2>
      <div class="sp-page-subhead">
        <span class="sp-pill sp-pill--secure">ðŸ”’ Secure</span>
      </div>
    </div>
  {% endif %}

  {% unless customer %}
    {%- assign return_to = request.path -%}
    {%- if request.query_string != blank -%}
      {%- assign return_to = return_to | append: '?' | append: request.query_string -%}
    {%- endif -%}

    {% if block.settings.redirect_to_login %}
      <meta
        http-equiv="refresh"
        content="0; url={{ routes.account_login_url }}?return_url={{ return_to | url_encode }}"
      >
      <script>
        (function () {
          var returnTo = {{ return_to | json }};
          window.location.href =
            {{ routes.account_login_url | json }} +
            "?return_url=" +
            encodeURIComponent(returnTo);
        })();
      </script>
      <p>Redirecting to loginâ€¦</p>
    {% else %}
      <div style="padding:14px;border:1px solid #e5e7eb;border-radius:12px;">
        <p><strong>Please log in</strong> to manage your subscriptions.</p>
        <p style="margin-top:10px;">
          <a href="{{ routes.account_login_url }}?return_url={{ return_to | url_encode }}">
            Log in
          </a>
        </p>
      </div>
    {% endif %}

  {% else %}
    <div id="subscriptions-portal-root">
      {% if request.design_mode %}
        <div style="padding: 14px; border: 1px dashed #d1d5db; border-radius: 10px;">
          <strong>Subscriptions Portal</strong>
          <p style="margin: 6px 0 0; color: #6b7280;">
            Logged-in preview may differ in the theme editor. View on the live storefront to test signed requests.
          </p>
        </div>
      {% else %}
        <p style="text-align: center;">Loadingâ€¦</p>
      {% endif %}
    </div>

    <script src="{{ 'subscription-portal.js' | asset_url }}" defer></script>
  {% endunless %}
</div>
{% schema %}
{
  "name": "Subscriptions Portal",
  "target": "section",
  "settings": [
    { 
      "type": "text", 
      "id": "heading", 
      "label": "Heading", 
      "default": "Manage your subscriptions" 
    },
    {
      "type": "text",
      "id": "portal_page_path",
      "label": "Portal page path",
      "default": "/pages/portal",
      "info": "Where this portal lives (example: /pages/portal). Used to map /pages/portal/* -> /apps/portal/*."
    },
    {
      "type": "text",
      "id": "endpoint",
      "label": "App Proxy base endpoint",
      "default": "/apps/portal",
      "info": "Base path for the portal routes (example: /apps/portal)."
    },
    { 
      "type": "checkbox", 
      "id": "redirect_to_login", 
      "label": "Auto-redirect to login when logged out", 
      "default": true 
    },
    { 
      "type": "checkbox", 
      "id": "debug", 
      "label": "Debug mode", 
      "default": false 
    },

    {
      "type": "header",
      "content": "Portal Rules"
    },
    {
      "type": "number",
      "id": "lock_window_days",
      "label": "Read-only window (days)",
      "default": 7,
      "info": "If a subscription is younger than this many days, it is read-only and shows the setup notice."
    },

    {
      "type": "header",
      "content": "Selling plan IDs (frequency)"
    },
    {
      "type": "text",
      "id": "selling_plan_week_4",
      "label": "Selling Plan ID â€“ 4 weeks (Monthly)",
      "default": "REQUIRED",
      "info": "Appstle selling plan ID for monthly subscriptions"
    },
    {
      "type": "text",
      "id": "selling_plan_week_8",
      "label": "Selling Plan ID â€“ 8 weeks (Every 2 months)",
      "default": "REQUIRED",
      "info": "Appstle selling plan ID for every-2-month subscriptions"
    },
    {
      "type": "text",
      "id": "selling_plan_week_2",
      "label": "Selling Plan ID â€“ 2 weeks (Twice a month)",
      "default": "REQUIRED",
      "info": "Appstle selling plan ID for twice-a-month subscriptions"
    },

    {
      "type": "header",
      "content": "Products"
    },
    {
      "type": "product",
      "id": "shipping_protection_product",
      "label": "Shipping Protection product",
      "info": "Used for the Shipping Protection toggle."
    },
    {
      "type": "product_list",
      "id": "products_available_to_add",
      "label": "Products Available to Add",
      "limit": 50
    },
    {
      "type": "product_list",
      "id": "addons",
      "label": "One-time Add-ons (Mug, Mixer, Tumbler, etc.)",
      "limit": 50
    }
  ]
}
{% endschema %}